<template>
  <div class="min-h-screen flex flex-col bg-gray-900">
    <!-- é¢„åŠ è½½é®ç½©å±‚ -->
    <div v-if="isPreloading" class="preload-overlay">
      <div class="preload-container">
        <!-- æ•°æ®åŠ è½½åŠ¨ç”» -->
        <div class="data-loader">
          <div class="data-cube">
            <div class="cube-face front">ğŸ“Š</div>
            <div class="cube-face back">ğŸ“ˆ</div>
            <div class="cube-face left">ğŸ“‹</div>
            <div class="cube-face right">ğŸ”</div>
            <div class="cube-face top">ğŸ’¡</div>
            <div class="cube-face bottom">âš¡</div>
          </div>
          <div class="data-rings">
            <div class="ring ring-1"></div>
            <div class="ring ring-2"></div>
            <div class="ring ring-3"></div>
          </div>
        </div>
        
        <!-- åŠ è½½ä¿¡æ¯ -->
        <div class="preload-info">
          <h3 class="text-xl font-bold text-white mb-2">æ­£åœ¨åŠ è½½ {{ preloadingName }}</h3>
          <p class="text-blue-400 mb-4">{{ categoryStore.preloadStatus }}</p>
          
          <!-- è¿›åº¦æ¡ -->
          <div class="progress-container">
            <div class="progress-bar" :style="{ width: categoryStore.preloadProgress + '%' }"></div>
          </div>
          <p class="text-gray-400 text-sm mt-2">{{ categoryStore.preloadProgress }}%</p>
          
          <!-- åŠ è½½é¡¹åˆ—è¡¨ -->
          <div class="loading-items mt-4">
            <div class="loading-item" :class="{ 'completed': categoryStore.preloadProgress >= 12.5 }">
              <span class="icon">ğŸ“„</span>
              <span>ä¸“åˆ©æ•°æ®</span>
            </div>
            <div class="loading-item" :class="{ 'completed': categoryStore.preloadProgress >= 25 }">
              <span class="icon">ğŸ“š</span>
              <span>è®ºæ–‡æ•°æ®</span>
            </div>
            <div class="loading-item" :class="{ 'completed': categoryStore.preloadProgress >= 37.5 }">
              <span class="icon">ğŸ”¬</span>
              <span>é¡¹ç›®æ•°æ®</span>
            </div>
            <div class="loading-item" :class="{ 'completed': categoryStore.preloadProgress >= 50 }">
              <span class="icon">ğŸ“ˆ</span>
              <span>è¶‹åŠ¿åˆ†æ</span>
            </div>
            <div class="loading-item" :class="{ 'completed': categoryStore.preloadProgress >= 62.5 }">
              <span class="icon">ğŸ•¸ï¸</span>
              <span>å…³è”ç½‘ç»œ</span>
            </div>
            <div class="loading-item" :class="{ 'completed': categoryStore.preloadProgress >= 75 }">
              <span class="icon">ğŸ”¥</span>
              <span>çƒ­é—¨æŠ€æœ¯</span>
            </div>
            <div class="loading-item" :class="{ 'completed': categoryStore.preloadProgress >= 87.5 }">
              <span class="icon">ğŸ“Š</span>
              <span>æˆç†Ÿåº¦åˆ†æ</span>
            </div>
            <div class="loading-item" :class="{ 'completed': categoryStore.preloadProgress >= 100 }">
              <span class="icon">ğŸŒ</span>
              <span>åŒºåŸŸåˆ†å¸ƒ</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Header -->
    <header class="bg-gray-900/90 backdrop-blur-lg border-b border-gray-700 sticky top-0 z-50">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="flex h-16 items-center justify-between">
          <!-- Logo -->
          <router-link to="/starter" class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-lg">
              <span class="text-white text-lg">ğŸ”¬</span>
            </div>
            <h1 class="text-white text-xl font-bold">æŠ€æœ¯è§£æå¹³å°</h1>
          </router-link>
          
          <!-- Right Actions -->
          <div class="flex items-center gap-4">
            <span class="text-sm text-gray-400 hidden sm:block">{{ userStore.username }}</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow">
      <section class="relative py-16 sm:py-24 overflow-hidden">
        <!-- Background -->
        <div class="absolute inset-0 bg-gradient-to-br from-gray-900 via-blue-900/20 to-gray-900"></div>
        <div class="absolute inset-0 bg-gradient-to-b from-gray-900/80 via-gray-900/60 to-gray-900/90"></div>
        
        <!-- Content -->
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
          <div class="max-w-4xl mx-auto">
            <!-- Title -->
            <div class="text-center mb-12">
              <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold tracking-tight text-white">æŠ€æœ¯åˆ†ç±»ç›®å½•</h1>
            </div>
            
            <!-- Classification Container -->
            <div class="bg-white/5 backdrop-blur-sm rounded-xl border border-white/10 p-6">
              <h2 class="text-xl font-semibold text-white mb-6 flex items-center gap-2">
                <span class="text-blue-400">ğŸ“‚</span>
                æŠ€æœ¯é¢†åŸŸåˆ†ç±»
              </h2>
              
              <!-- Categories -->
              <div class="space-y-3">
                <!-- AI Category -->
                <div class="classification-item rounded-lg p-4 bg-gradient-to-r from-blue-500/10 to-purple-500/10 cursor-pointer hover:from-blue-500/20 hover:to-purple-500/20 transition-all duration-300">
                  <div class="flex items-center justify-between" @click="toggleExpand('TP18')">
                    <div class="flex items-center gap-3">
                      <span class="text-2xl">ğŸ¤–</span>
                      <div>
                        <h3 class="font-semibold text-white text-lg">TP18 äººå·¥æ™ºèƒ½</h3>
                        <p class="text-gray-300 text-sm mt-1">Artificial Intelligence - åŒ…æ‹¬æœºå™¨å­¦ä¹ ã€æ·±åº¦å­¦ä¹ ã€è‡ªç„¶è¯­è¨€å¤„ç†ç­‰</p>
                      </div>
                    </div>
                    <div class="flex items-center gap-2">
                    
                      <span class="text-gray-400 transition-transform duration-200" :class="{ 'rotate-180': expandedCode === 'TP18' }">â–¼</span>
                    </div>
                  </div>
                  
                  <!-- Sub Items -->
                  <div v-if="expandedCode === 'TP18'" class="mt-4 space-y-2">
                    <div class="rounded-lg p-3 bg-white/5 cursor-pointer hover:bg-white/10 transition-all" @click="navigateToReport('TP181', 'è®¡ç®—æœºè§†è§‰')">
                      <div class="flex items-center gap-3">
                        <span class="text-blue-400">ğŸ‘ï¸</span>
                        <div>
                          <h4 class="font-medium text-white">TP181 è®¡ç®—æœºè§†è§‰</h4>
                          <p class="text-gray-400 text-xs mt-1">Computer Vision - å›¾åƒè¯†åˆ«ã€ç›®æ ‡æ£€æµ‹ã€å›¾åƒåˆ†å‰²ç­‰æŠ€æœ¯</p>
                        </div>
                      </div>
                    </div>
                    <div class="rounded-lg p-3 bg-white/5 cursor-pointer hover:bg-white/10 transition-all" @click="navigateToReport('TP182', 'è‡ªç„¶è¯­è¨€å¤„ç†')">
                      <div class="flex items-center gap-3">
                        <span class="text-green-400">ğŸ’¬</span>
                        <div>
                          <h4 class="font-medium text-white">TP182 è‡ªç„¶è¯­è¨€å¤„ç†</h4>
                          <p class="text-gray-400 text-xs mt-1">Natural Language Processing - æ–‡æœ¬åˆ†æã€æœºå™¨ç¿»è¯‘ã€æƒ…æ„Ÿåˆ†æç­‰</p>
                        </div>
                      </div>
                    </div>
                    <div class="rounded-lg p-3 bg-white/5 cursor-pointer hover:bg-white/10 transition-all" @click="navigateToReport('TP183', 'æœºå™¨å­¦ä¹ ')">
                      <div class="flex items-center gap-3">
                        <span class="text-purple-400">ğŸ§ </span>
                        <div>
                          <h4 class="font-medium text-white">TP183 æœºå™¨å­¦ä¹ </h4>
                          <p class="text-gray-400 text-xs mt-1">Machine Learning - ç›‘ç£å­¦ä¹ ã€æ— ç›‘ç£å­¦ä¹ ã€å¼ºåŒ–å­¦ä¹ ç­‰</p>
                        </div>
                      </div>
                    </div>
                    <div class="rounded-lg p-3 bg-white/5 cursor-pointer hover:bg-white/10 transition-all" @click="navigateToReport('TP184', 'çŸ¥è¯†è¡¨ç¤ºä¸æ¨ç†')">
                      <div class="flex items-center gap-3">
                        <span class="text-yellow-400">ğŸ’¡</span>
                        <div>
                          <h4 class="font-medium text-white">TP184 çŸ¥è¯†è¡¨ç¤ºä¸æ¨ç†</h4>
                          <p class="text-gray-400 text-xs mt-1">Knowledge Representation & Reasoning - çŸ¥è¯†å›¾è°±ã€é€»è¾‘æ¨ç†ç­‰</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Computer Technology -->
                <div class="classification-item rounded-lg p-4 bg-gradient-to-r from-cyan-500/10 to-blue-500/10 cursor-pointer hover:from-cyan-500/20 hover:to-blue-500/20 transition-all duration-300"
                     @click="navigateToReport('TP3', 'è®¡ç®—æœºæŠ€æœ¯')">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <span class="text-2xl">ğŸ’»</span>
                      <div>
                        <h3 class="font-semibold text-white text-lg">TP3 è®¡ç®—æœºæŠ€æœ¯</h3>
                        <p class="text-gray-300 text-sm mt-1">Computer Technology - è®¡ç®—æœºç¡¬ä»¶ã€è½¯ä»¶ã€ç½‘ç»œç­‰æŠ€æœ¯</p>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Automation -->
                <div class="classification-item rounded-lg p-4 bg-gradient-to-r from-green-500/10 to-emerald-500/10 cursor-pointer hover:from-green-500/20 hover:to-emerald-500/20 transition-all duration-300"
                     @click="navigateToReport('TP2', 'è‡ªåŠ¨åŒ–æŠ€æœ¯')">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <span class="text-2xl">âš™ï¸</span>
                      <div>
                        <h3 class="font-semibold text-white text-lg">TP2 è‡ªåŠ¨åŒ–æŠ€æœ¯</h3>
                        <p class="text-gray-300 text-sm mt-1">Automation Technology - è‡ªåŠ¨æ§åˆ¶ã€æœºå™¨äººæŠ€æœ¯ç­‰</p>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Electronics -->
                <div class="classification-item rounded-lg p-4 bg-gradient-to-r from-purple-500/10 to-pink-500/10 cursor-pointer hover:from-purple-500/20 hover:to-purple-500/20 transition-all duration-300"
                     @click="navigateToReport('TN', 'ç”µå­æŠ€æœ¯')">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <span class="text-2xl">âš¡</span>
                      <div>
                        <h3 class="font-semibold text-white text-lg">TN ç”µå­æŠ€æœ¯</h3>
                        <p class="text-gray-300 text-sm mt-1">Electronic Technology - ç”µå­ç”µè·¯ã€åŠå¯¼ä½“æŠ€æœ¯ç­‰</p>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Communication -->
                <div class="classification-item rounded-lg p-4 bg-gradient-to-r from-orange-500/10 to-red-500/10 cursor-pointer hover:from-orange-500/20 hover:to-red-500/20 transition-all duration-300"
                     @click="navigateToReport('TN91', 'é€šä¿¡æŠ€æœ¯')">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <span class="text-2xl">ğŸ“¡</span>
                      <div>
                        <h3 class="font-semibold text-white text-lg">TN91 é€šä¿¡æŠ€æœ¯</h3>
                        <p class="text-gray-300 text-sm mt-1">Communication Technology - æ— çº¿é€šä¿¡ã€å…‰çº¤é€šä¿¡ç­‰</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 border-t border-gray-800">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
          <div class="col-span-2 md:col-span-1">
            <div class="flex items-center gap-2 mb-4">
              <span class="text-2xl">ğŸ”¬</span>
              <span class="text-lg font-bold text-white">æŠ€æœ¯è§£æå¹³å°</span>
            </div>
            <p class="text-sm text-gray-500">é¢†å…ˆçš„æŠ€æœ¯è§£æå¹³å°ï¼Œä¸ºæŠ€æœ¯ç ”ç©¶å’Œåˆä½œæä¾›ä¸“ä¸šæ”¯æŒã€‚</p>
          </div>
          <div>
            <h3 class="text-sm font-semibold text-white mb-4">å¹³å°</h3>
            <ul class="space-y-2">
              <li><router-link to="/techmap" class="text-sm text-gray-500 hover:text-blue-400">æŠ€æœ¯å›¾è°±</router-link></li>
              <li><router-link to="/trend" class="text-sm text-gray-500 hover:text-blue-400">è¶‹åŠ¿åˆ†æ</router-link></li>
              <li><router-link to="/report" class="text-sm text-gray-500 hover:text-blue-400">åˆ†ææŠ¥å‘Š</router-link></li>
            </ul>
          </div>
          <div>
            <h3 class="text-sm font-semibold text-white mb-4">å…¬å¸</h3>
            <ul class="space-y-2">
              <li><a href="#" class="text-sm text-gray-500 hover:text-blue-400">å…³äºæˆ‘ä»¬</a></li>
              <li><a href="#" class="text-sm text-gray-500 hover:text-blue-400">è”ç³»æˆ‘ä»¬</a></li>
            </ul>
          </div>
          <div>
            <h3 class="text-sm font-semibold text-white mb-4">æ³•å¾‹</h3>
            <ul class="space-y-2">
              <li><a href="#" class="text-sm text-gray-500 hover:text-blue-400">éšç§æ”¿ç­–</a></li>
              <li><a href="#" class="text-sm text-gray-500 hover:text-blue-400">æœåŠ¡æ¡æ¬¾</a></li>
            </ul>
          </div>
        </div>
        <div class="mt-12 pt-8 border-t border-gray-800 text-center">
          <p class="text-sm text-gray-500">Â© 2024 æŠ€æœ¯è§£æå¹³å°ã€‚ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</p>
        </div>
      </div>
    </footer>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { useRouter } from 'vue-router'
import { useUserStore } from '@/stores/user'
import { useCategoryStore } from '@/stores/category'

const router = useRouter()
const userStore = useUserStore()
const categoryStore = useCategoryStore()
const expandedCode = ref<string | null>(null)
const isPreloading = ref(false)
const preloadingName = ref('')

function toggleExpand(code: string) {
  expandedCode.value = expandedCode.value === code ? null : code
}

async function navigateToReport(code: string, name: string) {
  // ä¿å­˜é€‰ä¸­çš„åˆ†ç±»åˆ° store
  categoryStore.setCategory(code, name)
  
  // æ˜¾ç¤ºé¢„åŠ è½½ç•Œé¢
  isPreloading.value = true
  preloadingName.value = name
  
  try {
    // é¢„åŠ è½½æ‰€æœ‰åˆ†ææ•°æ®
    const success = await categoryStore.preloadData(code)
    
    if (success) {
      // åŠ è½½æˆåŠŸï¼Œå»¶è¿Ÿä¸€ç‚¹è·³è½¬ä»¥è®©ç”¨æˆ·çœ‹åˆ°100%
      await new Promise(resolve => setTimeout(resolve, 500))
      
      // è·³è½¬åˆ°ä»ªè¡¨ç›˜ï¼ˆå¸¦åˆ†ç±»å‚æ•°ï¼‰
      router.push({
        path: '/',
        query: { code, name }
      })
    } else {
      // åŠ è½½å¤±è´¥ï¼Œä¹Ÿè·³è½¬ä½†ä¸å¸¦ç¼“å­˜
      router.push({
        path: '/',
        query: { code, name }
      })
    }
  } catch (error) {
    console.error('é¢„åŠ è½½å¤±è´¥:', error)
    // å‘ç”Ÿé”™è¯¯ä¹Ÿç»§ç»­è·³è½¬
    router.push({
      path: '/',
      query: { code, name }
    })
  } finally {
    isPreloading.value = false
  }
}
</script>

<style scoped>
.classification-item {
  opacity: 0;
  animation: fadeInUp 0.6s ease forwards;
}

.classification-item:nth-child(1) { animation-delay: 0.1s; }
.classification-item:nth-child(2) { animation-delay: 0.2s; }
.classification-item:nth-child(3) { animation-delay: 0.3s; }
.classification-item:nth-child(4) { animation-delay: 0.4s; }
.classification-item:nth-child(5) { animation-delay: 0.5s; }

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* é¢„åŠ è½½é®ç½©å±‚æ ·å¼ */
.preload-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(17, 24, 39, 0.98);
  backdrop-filter: blur(10px);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

.preload-container {
  text-align: center;
  padding: 2rem;
}

/* 3Dæ•°æ®ç«‹æ–¹ä½“åŠ¨ç”» */
.data-loader {
  position: relative;
  width: 120px;
  height: 120px;
  margin: 0 auto 2rem;
  perspective: 400px;
}

.data-cube {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 50px;
  height: 50px;
  transform-style: preserve-3d;
  animation: rotateCube 4s linear infinite;
  transform: translate(-50%, -50%);
}

.cube-face {
  position: absolute;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(147, 51, 234, 0.3));
  border: 1px solid rgba(99, 102, 241, 0.5);
  border-radius: 8px;
}

.cube-face.front { transform: translateZ(25px); }
.cube-face.back { transform: rotateY(180deg) translateZ(25px); }
.cube-face.left { transform: rotateY(-90deg) translateZ(25px); }
.cube-face.right { transform: rotateY(90deg) translateZ(25px); }
.cube-face.top { transform: rotateX(90deg) translateZ(25px); }
.cube-face.bottom { transform: rotateX(-90deg) translateZ(25px); }

@keyframes rotateCube {
  0% { transform: translate(-50%, -50%) rotateX(0deg) rotateY(0deg); }
  100% { transform: translate(-50%, -50%) rotateX(360deg) rotateY(360deg); }
}

/* ç¯å½¢åŠ¨ç”» */
.data-rings {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 100%;
  height: 100%;
}

.ring {
  position: absolute;
  border: 2px solid transparent;
  border-radius: 50%;
  animation: ringPulse 2s ease-in-out infinite;
}

.ring-1 {
  width: 80px;
  height: 80px;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  border-color: rgba(59, 130, 246, 0.5);
  animation-delay: 0s;
}

.ring-2 {
  width: 100px;
  height: 100px;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  border-color: rgba(147, 51, 234, 0.4);
  animation-delay: 0.3s;
}

.ring-3 {
  width: 120px;
  height: 120px;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  border-color: rgba(236, 72, 153, 0.3);
  animation-delay: 0.6s;
}

@keyframes ringPulse {
  0%, 100% { 
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  50% { 
    transform: translate(-50%, -50%) scale(1.1);
    opacity: 0.5;
  }
}

/* è¿›åº¦æ¡ */
.progress-container {
  width: 300px;
  height: 6px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 3px;
  overflow: hidden;
  margin: 0 auto;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
  border-radius: 3px;
  transition: width 0.3s ease;
  box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
}

/* åŠ è½½é¡¹åˆ—è¡¨ */
.loading-items {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 0.5rem;
  max-width: 400px;
  margin: 0 auto;
}

.loading-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  font-size: 0.75rem;
  color: rgba(255, 255, 255, 0.5);
  transition: all 0.3s ease;
}

.loading-item .icon {
  font-size: 1rem;
  filter: grayscale(100%);
  transition: filter 0.3s ease;
}

.loading-item.completed {
  color: #10b981;
  background: rgba(16, 185, 129, 0.1);
}

.loading-item.completed .icon {
  filter: grayscale(0%);
}

.preload-info h3 {
  background: linear-gradient(90deg, #fff, #a5b4fc);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
</style>
